---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import PageHero from '../../components/PageHero.astro';
import BlogPostCard from '../../components/BlogPostCard.astro';
import PortfolioCard from '../../components/PortfolioCard.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  const portfolio = await getCollection('portfolio');

  // 全タグを収集
  const allTags = new Set<string>();
  posts.forEach((post) => post.data.tags.forEach((tag) => allTags.add(tag)));
  portfolio.forEach((project) => project.data.tags.forEach((tag) => allTags.add(tag)));

  return Array.from(allTags).map((tag) => ({
    params: { tag },
    props: {
      tag,
      posts: posts.filter((post) => post.data.tags.includes(tag)),
      portfolio: portfolio.filter((project) => project.data.tags.includes(tag)),
    },
  }));
}

const { tag, posts, portfolio } = Astro.props;

// 日付順でソート
const sortedPosts = posts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
const sortedPortfolio = portfolio.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const tagDescription = `${sortedPosts.length} blog post${sortedPosts.length !== 1 ? 's' : ''} and ${sortedPortfolio.length} portfolio project${sortedPortfolio.length !== 1 ? 's' : ''}`;
---

<BaseLayout title={`#${tag} - Astro Nightwalk`}>
  <Header />

  <main class="pt-20">
    <PageHero 
      title={`#${tag}`}
      description={tagDescription}
      backLink={{ href: '/tags', label: 'All Tags' }}
    />

    <!-- Blog Posts -->
    {sortedPosts.length > 0 && (
      <section class="py-16 bg-nightwalk-dark border-b border-white/10">
        <div class="container mx-auto px-4">
          <h2 class="text-2xl font-bold text-white mb-8">Blog Posts</h2>
          <div class="max-w-3xl space-y-6">
            {sortedPosts.map((post) => (
              <BlogPostCard post={post} showTags={false} locale="ja-JP" />
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- Portfolio Projects -->
    {sortedPortfolio.length > 0 && (
      <section class="py-16 bg-nightwalk-dark">
        <div class="container mx-auto px-4">
          <h2 class="text-2xl font-bold text-white mb-8">Portfolio Projects</h2>
          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl">
            {
              sortedPortfolio.map((project) => (
                <PortfolioCard
                  title={project.data.title}
                  description={project.data.description}
                  slug={project.slug}
                  image={project.data.image}
                  tags={project.data.tags}
                  featured={project.data.featured}
                />
              ))
            }
          </div>
        </div>
      </section>
    )}
  </main>

  <Footer />
</BaseLayout>
