---
// HeroScene.astro - Three.js街並みシーンのコンテナ
---

<div id="hero-canvas-container" class="hero-scene">
  <canvas id="hero-canvas" class="hero-canvas"></canvas>
  <div class="hero-content">
    <slot />
  </div>
  <!-- Static fallback for reduced motion or no WebGL -->
  <div id="hero-fallback" class="absolute inset-0 bg-gradient-to-b from-nightwalk-dark via-nightwalk-purple to-nightwalk-orange hidden">
    <div class="hero-content">
      <slot />
    </div>
  </div>
  <noscript>
    <div class="absolute inset-0 bg-gradient-to-b from-nightwalk-dark via-nightwalk-purple to-nightwalk-orange">
      <div class="hero-content">
        <slot />
      </div>
    </div>
  </noscript>
</div>

<script>
  import { initCityScene, disposeCityScene } from '../three/CityScene';

  let isInitialized = false;

  function setupScene() {
    const container = document.getElementById('hero-canvas-container');
    const canvas = document.getElementById('hero-canvas') as HTMLCanvasElement;
    const fallback = document.getElementById('hero-fallback');

    if (!canvas || !container) return;

    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    if (prefersReducedMotion) {
      canvas.style.display = 'none';
      fallback?.classList.remove('hidden');
    } else {
      initCityScene(canvas, container);
      isInitialized = true;
    }
  }

  function cleanupScene() {
    if (isInitialized) {
      disposeCityScene();
      isInitialized = false;
    }
  }

  // View Transitions: ページ遷移後の再初期化
  document.addEventListener('astro:page-load', () => {
    setupScene();
  });

  // View Transitions: ページ離脱時のクリーンアップ
  document.addEventListener('astro:before-swap', () => {
    cleanupScene();
  });

  // Reduced motion preference changes
  window.matchMedia('(prefers-reduced-motion: reduce)').addEventListener('change', (e) => {
    const canvas = document.getElementById('hero-canvas') as HTMLCanvasElement;
    const container = document.getElementById('hero-canvas-container');
    const fallback = document.getElementById('hero-fallback');

    if (e.matches) {
      cleanupScene();
      if (canvas) canvas.style.display = 'none';
      fallback?.classList.remove('hidden');
    } else {
      if (canvas) canvas.style.display = 'block';
      fallback?.classList.add('hidden');
      if (canvas && container) {
        initCityScene(canvas, container);
        isInitialized = true;
      }
    }
  });
</script>
